{% extends "base.html" %}

{% block content %}
<h1>Receive Stock</h1>

<!-- Lot Number Scan / Lookup -->
<div class="mb-3">
    <label class="form-label">Scan Lot Number</label>
    <div class="input-group">
        <input type="text" id="lot_number_input" class="form-control" placeholder="Scan or enter Lot Number">
        <button class="btn btn-primary" type="button" onclick="lookupLot()">Check</button>
    </div>
</div>

<!-- Receive Stock Form -->
<form action="/receive" method="POST">
    <div class="mb-3">
        <label class="form-label">Name</label>
        <input type="text" name="name" id="name" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Lot Number</label>
        <input type="text" name="lot_number" id="lot_number" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Expiry Date</label>
        <input type="date" name="expiry_date" id="expiry_date" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Received Date</label>
        <input type="date" name="received_date" id="received_date" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Acceptance Tested</label>
        <input type="date" name="acceptance_tested" id="acceptance_tested" class="form-control">
    </div>

    <div class="mb-3">
        <label class="form-label">Passed By</label>
        <input type="text" name="passed_by" id="passed_by" class="form-control">
    </div>

    <div class="mb-3">
        <label class="form-label">Panel Code</label>
        <select name="panel_code" class="form-control" required>
            <option value="">-- Select Panel --</option>
            <option value="TBNK">TBNK</option>
            <option value="PNH">PNH</option>
            <option value="Lymphocyte Subsets">Lymphocyte Subsets</option>
            <option value="CD4 Monitoring">CD4 Monitoring</option>
            <!-- Add more panels if needed -->
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Location</label>
        <select name="location" class="form-control" required>
            <option value="In Use">In Use</option>
            <option value="Flow Lab">Flow Lab</option>
            <option value="Stock Room">Stock Room</option>
        </select>
    </div>

    <button type="submit" class="btn btn-success">Receive Stock</button>
    <a href="/" class="btn btn-secondary">Back to Stock List</a>
</form>

<!-- Javascript for AJAX Lookup -->
<script>
function lookupLot() {
    const lotNumber = document.getElementById('lot_number_input').value;
    if (!lotNumber) return;

    fetch('/api/lookup_lot/' + encodeURIComponent(lotNumber))
        .then(response => response.json())
        .then(data => {
            if (Object.keys(data).length === 0) {
                alert('Lot Number not found. Please enter stock details.');
            } else {
                document.getElementById('name').value = data.name || '';
                document.getElementById('lot_number').value = data.lot_number || '';
                document.getElementById('expiry_date').value = data.expiry_date || '';
                document.getElementById('acceptance_tested').value = data.acceptance_tested || '';
                document.getElementById('passed_by').value = data.passed_by || '';
            }

            // Always fill lot_number field in the form:
            document.getElementById('lot_number').value = lotNumber;
        });
}

// Set today's date for Received Date field
window.onload = function() {
    const today = new Date().toISOString().substr(0, 10);
    document.getElementById('received_date').value = today;
};
</script>

{% endblock %}